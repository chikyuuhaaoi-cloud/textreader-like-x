<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’ç©ºæ–‡åº«ğ•</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://abs.twimg.com/responsive-web/client-web-legacy/icon-ios.b1cf6835.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root { --bg-color: #000; --border-color: #2f3336; --text-color: #e7e9ea; --sub-text-color: #71767b; --accent-color: #1d9bf0; --like-color: #f91880; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 60px; }
        header { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); height: 50px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; font-weight: bold; }
        
        #file-selector { padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color); background: #111; }
        .mode-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #333; color: #fff; margin-bottom: 8px; }
        
        .encoding-btn { 
            background: none; border: 1px solid var(--accent-color); color: var(--accent-color); 
            padding: 4px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-top: 8px;
        }
        .encoding-btn:hover { background: rgba(29, 155, 240, 0.1); }

        .post { display: flex; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .post-content { flex-grow: 1; }
        .post-header { font-size: 15px; margin-bottom: 2px; }
        .author-name { font-weight: bold; }
        .post-text { font-size: 15px; line-height: 1.6; white-space: pre-wrap; margin-bottom: 10px; }
        
        .post-actions { display: flex; justify-content: space-between; max-width: 350px; color: var(--sub-text-color); }
        .btn-like.active { color: var(--like-color); font-variation-settings: 'FILL' 1; }
        
        ruby rt { font-size: 0.6em; color: var(--sub-text-color); }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 50px; background: #000; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; }
    </style>
</head>
<body>

<header id="header-title">é’ç©ºæ–‡åº«ğ•</header>

<div id="file-selector">
    <div id="encoding-display" class="mode-badge">ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: Shift-JIS</div><br>
    <input type="file" id="file-input" accept=".txt"><br>
    <button class="encoding-btn" onclick="toggleEncoding()">æ–‡å­—åŒ–ã‘ã—ãŸã‚‰æŠ¼ã™ (UTF-8 â‡„ SJIS)</button>
</div>

<div id="timeline"></div>

<nav class="bottom-nav">
    <span class="material-symbols-outlined">home</span>
    <span class="material-symbols-outlined">search</span>
    <span class="material-symbols-outlined">notifications</span>
    <span class="material-symbols-outlined">mail</span>
</nav>

<script>
let allChunks = [];
let currentIndex = 0;
let authorName = "æ–‡è±ª";
let currentFileObject = null;
let currentEncoding = 'Shift-JIS';

window.onload = function() {
    const fileInput = document.getElementById('file-input');

    fileInput.onchange = function(e) {
        currentFileObject = e.target.files[0];
        if (!currentFileObject) return;
        readFile();
    };

    // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ‡ã‚Šæ›¿ãˆã¦å†èª­ã¿è¾¼ã¿
    window.toggleEncoding = function() {
        currentEncoding = (currentEncoding === 'Shift-JIS') ? 'UTF-8' : 'Shift-JIS';
        document.getElementById('encoding-display').innerText = "ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: " + currentEncoding;
        if (currentFileObject) readFile();
    };

    function readFile() {
        const reader = new FileReader();
        reader.onload = function(event) {
            setupBook(event.target.result);
        };
        reader.readAsText(currentFileObject, currentEncoding);
    }

    function setupBook(text) {
        const lines = text.split('\n');
        authorName = lines[1] ? lines[1].trim() : "æ–‡è±ª";
        document.getElementById('header-title').innerText = authorName + "ğ•";
        
        let cleanText = text.replace(/ï¼»ï¼ƒ.*?ï¼½/g, '');
        allChunks = [];
        const chunkSize = 140;
        for (let i = 0; i < cleanText.length; i += chunkSize) {
            allChunks.push(cleanText.substring(i, i + chunkSize));
        }

        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        currentIndex = 0;
        
        // ã—ãŠã‚Šã®å¾©å…ƒï¼ˆç°¡æ˜“ç‰ˆï¼šåˆå›20ä»¶è¡¨ç¤ºï¼‰
        loadMore(20);
    }

    function loadMore(count) {
        const timeline = document.getElementById('timeline');
        const end = Math.min(currentIndex + count, allChunks.length);
        const savedLike = localStorage.getItem('like_index_' + (currentFileObject ? currentFileObject.name : ""));

        for (let i = currentIndex; i < end; i++) {
            const chunk = processRuby(allChunks[i]);
            const isLiked = (savedLike == i);
            const post = document.createElement('div');
            post.className = 'post';
            post.id = 'post-' + i;
            post.innerHTML = `
                <div class="avatar">${authorName[0]}</div>
                <div class="post-content">
                    <div class="post-header">
                        <span class="author-name">${authorName}</span>
                        <span style="color:var(--sub-text-color)"> @aozora Â· ${i+1}</span>
                    </div>
                    <div class="post-text">${chunk}</div>
                    <div class="post-actions">
                        <span class="material-symbols-outlined">chat_bubble</span>
                        <span class="material-symbols-outlined">repeat</span>
                        <div class="btn-like ${isLiked ? 'active' : ''}" onclick="setLike(${i})">
                            <span class="material-symbols-outlined">favorite</span>
                        </div>
                        <span class="material-symbols-outlined">share</span>
                    </div>
                </div>
            `;
            timeline.appendChild(post);
        }
        currentIndex = end;
    }

    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            if (currentIndex < allChunks.length) loadMore(15);
        }
    };

    window.setLike = function(index) {
        localStorage.setItem('like_index_' + currentFileObject.name, index);
        document.querySelectorAll('.btn-like').forEach(btn => btn.classList.remove('active'));
        document.getElementById('post-' + index).querySelector('.btn-like').classList.add('active');
    };

    function processRuby(text) {
        let t = text.replace(/[|ï½œ]([^ã€Š]+)ã€Š([^ã€‹]+)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        t = t.replace(/([ä¸€-é¾ ã€…]+)ã€Š([^ã€‹]+)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        return t.replace(/\n/g, '<br>');
    }
};
</script>
</body>
</html>