<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://abs.twimg.com/responsive-web/client-web-legacy/icon-ios.b1cf6835.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’ç©ºæ–‡åº«ğ•</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root { --bg-color: #000; --border-color: #2f3336; --text-color: #e7e9ea; --sub-text-color: #71767b; --like-color: #f91880; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 60px; }
        header { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); height: 50px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; font-weight: bold; }
        #file-selector { padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color); }
        
        .post { display: flex; padding: 12px 16px; border-bottom: 1px solid var(--border-color); transition: background 0.3s; }
        .avatar { width: 45px; height: 45px; background: #333; border-radius: 50%; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: #fff; }
        .post-content { flex-grow: 1; }
        .post-header { font-size: 15px; margin-bottom: 2px; }
        .author-name { font-weight: bold; }
        .post-text { font-size: 15px; line-height: 1.6; white-space: pre-wrap; margin-bottom: 10px; }
        
        .post-actions { display: flex; justify-content: space-between; max-width: 350px; color: var(--sub-text-color); }
        .action-btn { cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .action-btn:hover { color: var(--text-color); }
        .btn-like.active { color: var(--like-color); font-variation-settings: 'FILL' 1; }
        
        ruby rt { font-size: 0.6em; color: var(--sub-text-color); }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 50px; background: #000; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; }
    </style>
</head>
<body>

<header id="header-title">é’ç©ºæ–‡åº«ğ•</header>

<div id="file-selector">
    <input type="file" id="file-input" accept=".txt">
    <p id="status" style="font-size:12px; color:var(--sub-text-color); margin-top:10px;">ä½œå®¶åãŒã¤ã¶ã‚„ãã¾ã™</p>
</div>

<div id="timeline"></div>
<div id="load-more-trigger" style="height: 50px;"></div>

<nav class="bottom-nav">
    <span class="material-symbols-outlined">home</span>
    <span class="material-symbols-outlined">search</span>
    <span class="material-symbols-outlined">notifications</span>
    <span class="material-symbols-outlined">mail</span>
</nav>

<script>
let allChunks = [];
let currentIndex = 0;
const displayCount = 15; // ä¸€å›ã«èª­ã¿è¾¼ã‚€æ•°
let authorName = "æ–‡è±ª";
let currentFile = "";

window.onload = function() {
    const fileInput = document.getElementById('file-input');
    const timeline = document.getElementById('timeline');

    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        currentFile = file.name;

        const reader = new FileReader();
        reader.onload = function(event) {
            const text = event.target.result;
            setupBook(text);
        };
        reader.readAsText(file, 'Shift-JIS');
    };

    function setupBook(text) {
        // ä½œå®¶åã®æŠ½å‡ºï¼ˆå†’é ­æ•°è¡Œã‹ã‚‰å–å¾—ï¼‰
        const lines = text.split('\n');
        authorName = lines[1] ? lines[1].trim() : "æ–‡è±ª";
        document.getElementById('header-title').innerText = authorName + "ğ•";
        
        // æœ¬æ–‡ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨åˆ†å‰²
        let cleanText = text.replace(/ï¼»ï¼ƒ.*?ï¼½/g, '');
        allChunks = [];
        const chunkSize = 140;
        for (let i = 0; i < cleanText.length; i += chunkSize) {
            allChunks.push(cleanText.substring(i, i + chunkSize));
        }

        currentIndex = 0;
        timeline.innerHTML = '';
        
        // ã—ãŠã‚Šã®ç¢ºèª
        const saved = localStorage.getItem('like_index_' + currentFile);
        if (saved) {
            currentIndex = Math.max(0, parseInt(saved) - 5); // ã—ãŠã‚Šã®å°‘ã—å‰ã‹ã‚‰è¡¨ç¤º
        }

        loadMore();
    }

    function loadMore() {
        const end = Math.min(currentIndex + displayCount, allChunks.length);
        const savedLike = localStorage.getItem('like_index_' + currentFile);

        for (let i = currentIndex; i < end; i++) {
            const chunk = processRuby(allChunks[i]);
            const isLiked = (savedLike == i);
            
            const post = document.createElement('div');
            post.className = 'post';
            post.id = 'post-' + i;
            post.innerHTML = `
                <div class="avatar">${authorName[0]}</div>
                <div class="post-content">
                    <div class="post-header">
                        <span class="author-name">${authorName}</span>
                        <span style="color:var(--sub-text-color)"> @${currentFile.split('.')[0]} Â· ${i+1}</span>
                    </div>
                    <div class="post-text">${chunk}</div>
                    <div class="post-actions">
                        <span class="material-symbols-outlined">chat_bubble</span>
                        <span class="material-symbols-outlined">repeat</span>
                        <div class="action-btn btn-like ${isLiked ? 'active' : ''}" onclick="setLike(${i})">
                            <span class="material-symbols-outlined">${isLiked ? 'favorite' : 'favorite'}</span>
                        </div>
                        <span class="material-symbols-outlined">share</span>
                    </div>
                </div>
            `;
            timeline.appendChild(post);
        }
        currentIndex = end;
    }

    // ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®åˆ¤å®š
    window.onscroll = function() {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            if (currentIndex < allChunks.length) loadMore();
        }
    };

    window.setLike = function(index) {
        // å‰ã®ã„ã„ã­ã‚’æ¶ˆã™
        document.querySelectorAll('.btn-like').forEach(btn => btn.classList.remove('active'));
        // æ–°ã—ã„ã„ã„ã­ã‚’ç™»éŒ²
        const targetPost = document.getElementById('post-' + index);
        targetPost.querySelector('.btn-like').classList.add('active');
        
        localStorage.setItem('like_index_' + currentFile, index);
        console.log("ã—ãŠã‚Šã‚’ä¿å­˜ã—ã¾ã—ãŸ: " + index);
    };

    function processRuby(text) {
        let t = text.replace(/[|ï½œ]([^ã€Š]+)ã€Š([^ã€‹]+)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        t = t.replace(/([ä¸€-é¾ ã€…]+)ã€Š([^ã€‹]+)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        return t.replace(/\n/g, '<br>');
    }
};
</script>
</body>
</html>